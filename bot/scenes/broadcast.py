from meetapp.models import User

from .scene_router import SceneRouter


class BroadcastScene:
    def handle(self, update, context):
        context.user_data['scene'] = self
        message = update.message or update.callback_query.message
        message.reply_text(
            "üì¢ –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:"
        )

    def process(self, update, context):
        scene = SceneRouter.get('main_menu')
        text = update.message.text
        count = 0

        for user in User.objects.all():
            try:
                context.bot.send_message(
                    chat_id=user.tg_id,
                    text=f"üì¢ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤:\n\n{text}"
                )
                count += 1
            except Exception as e:
                print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å {user.username}: {e}")

        update.message.reply_text(
            f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º."
        )
        scene.handle(update, context)
